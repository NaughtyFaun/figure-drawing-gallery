<!DOCTYPE html>
<html>
<head>
	<title>Image ($image_id)</title>
    <link rel="stylesheet" href="/static/style.css">
    <script type="text/javascript" src="/static/img_params.js"></script>
    <script type="text/javascript" src="/static/study_timer.js"></script>
</head>
<body>
    <div style="display: none" id="image-id" >$image_id</div>
    <div style="display: none">$path</div>
	<div class="modal">
        <img class="modal-bg" src="/image/$image_id" alt="$image_id:$path">
        <img class="modal-img" src="/image/$image_id" alt="$image_id:$path">
        <div class="modal-controls">
            <div class="row timer">
                <span class="timer-icon"></span>&nbsp;&nbsp;
                <span id="time-current">0</span>&nbsp;/&nbsp;<span id="time-planned">0</span>
                <span class="space"/>
                <button id="timer-start" started="">Start</button>
            </div>
            <div class="row">
                <span>View: </span>
                <select id="facing">
                    <option value="front">Front</option>
                    <option value="side">Side</option>
                    <option value="back">Back</option>
                </select>
                <span class="space"/>
                <span>Source: </span>
                <select id="source-type">
                    <option value="academic">Academic</option>
                    <option value="pron">Pron</option>
                </select>
            </div>
            <div class="row">
                <button class="fav" id="is-fav" value="$is_fav"></button>
                <span>Diff: </span>
                <select id="difficulty">
                    <option value="0">Beginner</option>
                    <option value="10">Pro</option>
                </select>
                <label for="same-folder">Same folder:</label>
                <input type="checkbox" id="same-folder" value="true">
            </div>
<!--            <div id="caption">-->
<!--                <ul>-->
<!--                    <li><p id="timer">$timer</p></li>-->
<!--                    <li>Count: $count</li>-->
<!--                    <li>Time spent: $time_spent seconds</li>-->
<!--                    <li>Facing: $facing</li>-->
<!--                    <button onclick="incrementCount($image_id)">Increment count</button>-->
<!--                </ul>-->
<!--            </div>-->
            <div class="row">
                <button id="prev">Prev</button>
                <button id="next">Next</button>
            </div>
        </div>
	</div>

    <script>
    function incrementCount(imageId) {
        fetch(`/increment_count/$${imageId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.text();
            })
            .catch(error => {
                console.error('There was a problem with the fetch operation:', error);
            });
        }
    </script>

    <script>
        window.onload = function()
        {
            console.log("Page Loaded!")

            let imgParams = new ImgParams('image-id', 'facing', 'source-type', 'same-folder', 'difficulty', 'time-planned', 'is-fav')
            imgParams.setParamsFromGET()


            // next
            const nextButton = document.getElementById("next");
            nextButton.addEventListener("click", function ()
            {
                const curParams = imgParams.getParamsAsGET();
                const curUrl = window.location.href.split('/');
                const domain = `$${curUrl[0]}//$${curUrl[2]}`;
                const url = `$${domain}/study-random?$${curParams}`;

                const prevParams = document.getElementById("prev").getAttribute("prev-params");
                history.replaceState(null, null, `/study-image/$image_id?$${prevParams}`);
                window.location.href = url;
            });

            // prev
            const prevButton = document.getElementById("prev");
            prevButton.setAttribute("prev-params", imgParams.getParamsAsGET())
            prevButton.addEventListener("click", function ()
            {
                window.history.back()
            });

            //fab is-fav
            const favButton = document.getElementById("is-fav");
            if (favButton.value === "1") { favButton.classList.add("on") }
            favButton.addEventListener("click", function ()
            {
                console.log(favButton.value)
                let val = (parseInt(favButton.value) + 1) % 2;

                favButton.classList.add('loading-fav')
                fetch(`/set-image-fav?$${imgParams.getParamsFav(val)}`)
                    .then(response => {
                        if (!response.ok) throw new Error('Network response was not ok');

                        if (val === 0) {favButton.classList.remove("on")}
                        else favButton.classList.add("on")

                        favButton.value = val;
                        favButton.classList.remove('loading-fav')
                    })
                    .catch(error => {
                        console.error('There was a problem with the fetch operation:', error);
                        favButton.classList.remove('loading-fav')
                    });
            });

            // study timer
            const timer = new StudyTimer($timer, 'time-current', "time-planned")

            const timerButton = document.getElementById("timer-start");
            timerButton.addEventListener("click", function ()
            {
                timer.start()
                timerButton.textContent = "Alga Only";
                timerButton.setAttribute("disabled", "true")

                fetch(`/set-image-last-viewed?$${imgParams.getImgIdAsGET()}`)
                    .then(response => {
                        if (!response.ok) throw new Error('Network response was not ok');
                        console.log("Last Viewed time updated!")
                    })
                    .catch(error => {
                        console.error('There was a problem with the fetch operation:', error);
                    });
            });
        }
    </script>
</body>
</html>